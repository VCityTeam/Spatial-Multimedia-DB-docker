os: linux
dist: focal
language: generic

env:
  global:
    # PostgreSQL version 12, the user is travis and the port is 5433 instead
    # refer to https://docs.travis-ci.com/user/database-setup/#using-a-different-postgresql-version
    - PGPORT=5432
    - PGUSER=postgres
  
addons:
  # For the focal distro, Travis tries to use postgresql version 12 that
  # fails on launching the service with message
  #    Failed to start postgresql@12-main.service: Unit postgresql@12-main.service not found.
  # A workaround to install an anterior version of postgresql is provided by
  # https://stackoverflow.com/questions/49850020/psql-could-not-connect-to-server-error-on-travis-ci
  # but alas such installations fail with respective message
  #    E: Package 'postgresql-9.6' has no installation candidate
  #    E: Unable to locate package postgresql-10
  # postgresql: '10'
  # apt:
  #  packages:
  #  - postgresql-10
  #  - postgresql-client-10
  # Pinning the version to make sure
  postgresql: "12"
  apt:
    packages:
    - postgresql-12
    - postgresql-client-12

services:
  - postgresql
  - docker

before_install:
  - |
    # Install a more recent version than the default one
    export  DOCKER_COMPOSE_VERSION=1.29.2
    sudo rm /usr/local/bin/docker-compose
    curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
    chmod +x docker-compose
    sudo mv docker-compose /usr/local/bin

before_script:
  # Travis context requires a specific database configuration
  - psql -c 'create database extendeddoc;' --username=travis --port=5432
  - psql -c 'create database extendeddoc;' --username=postgres --port=5432
  - psql -c '\l' --username=postgres --port=5432

jobs:
  include:
    - stage: Building and running Spatial-Multimedia-DB container
      script:
        - docker build -t vcity:Spatial-Multimedia-DB Spatial-Multimedia-DB-context --build-arg POSTGRES_PORT=8995 --build-arg POSTGRES_PASSWORD="" --build-arg POSTGRES_HOST=localhost
        - docker run --rm --detach -t vcity:Spatial-Multimedia-DB
        - travis_wait 2 
        - docker stop $(docker ps -a -q --filter ancestor=vcity:Spatial-Multimedia-DB --format="{{.ID}}")
    - stage: Building and running docker-compose
      script:
        - |
          cd Example
          docker-compose build
          docker-compose up -d
          travis_wait 2
          docker-compose down
    - stage: "Markdown link checks"
      language: node_js
      node_js: 12
      script:
        - npm install --global remark-cli remark-validate-links
        - remark -u validate-links .
        - |
          export FAILURE_THRESHOLD=0
          export warnings=`remark -u validate-links . 2>&1 | grep warning | grep "Link to unknown" | wc -l`
          if [ $warnings -gt $FAILURE_THRESHOLD ]; then
            exit 1;
          fi

